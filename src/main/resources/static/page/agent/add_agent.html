<html lang="zh">
<head>
	<title>新建代理</title>
	<link rel="stylesheet" href="/static/lib/layui-v2.5.5/css/layui.css" media="all">
	<link rel="stylesheet" href="/static/lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
	<link rel="stylesheet" href="/static/css/layuimini.css?v=2.0.4.2" media="all">
	<link rel="stylesheet" href="/static/css/themes/default.css" media="all">
	<link rel="stylesheet" href="/static/css/public.css" media="all">
	<!--[if lt IE 9]>
	<script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
	<script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->
	<style>
		.show {
			/*display: none;*/
		}
		.agent-type-search{
			display: inline-block;
			width: 100%;
			min-height: 26px;
			margin: 0;
			padding-left: 4px;
			padding-right: 4px;
			position: relative;
			z-index: 10000;
			white-space: nowrap;
		}
		.agent-type-list{
			max-height: 400px;
			padding: 0 0 0 4px;
			margin: 4px 4px 4px 0;
			position: relative;
			overflow-x: hidden;
			overflow-y: auto;
			-webkit-tap-highlight-color: transparent;
		}
		.agent-type-list li{
			list-style: none;
			display: list-item;
			background-image: none;
		}
		.agent-type-list li:hover{
			color: white;
			background-color: #428bca;
		}
		.agent-type-label{
			padding: 3px 7px 4px;
			margin: 0;
			cursor: pointer;
			min-height: 1em;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		.agent-type-label p{
			display: block;
			margin-block-start: 1em;
			margin-block-end: 1em;
			margin-inline-start: 0;
			margin-inline-end: 0;
		}
		.agent-type-label strong{
			font-weight: bold;
		}
	</style>
</head>
<body>
<div class="layuimini-container layuimini-page-anim layui-col-xs12">
	<div class="layui-form layuimini-form layui-col-sm12 layui-col-md6">
		<div class="layui-form-item show">
			<label class="layui-form-label" for="type">代理类型</label>
			<div class="layui-input-block">
				<div id="type"></div>
			</div>
		</div>
		<div class="layui-form-item show">
			<label class="layui-form-label">代理名称</label>
			<div class="layui-input-block">
				<label for="name">
					<input
							type="text"
							id="name"
							name="name"
							lay-verify="required"
							lay-reqtext="代理名称不能为空"
							class="layui-input">
				</label>
			</div>
		</div>
		<div class="layui-form-item show">
			<label class="layui-form-label">执行计划</label>
			<div class="layui-input-block">
				<label for="schedule">
					<select
							id="schedule"
							name="schedule"
							class="layui-select">
						<option value="">请选择</option>
					</select>
				</label>
			</div>
		</div>
		<div class="layui-form-item show">
			<label class="layui-form-label">结果保存时间</label>
			<div class="layui-input-block">
				<label for="keepDataTime">
					<select
							id="keepDataTime"
							name="keepDataTime"
							class="layui-select">
						<option value="">请选择</option>
					</select>
				</label>
			</div>
		</div>
		<div class="layui-form-item show">
			<label class="layui-form-label">数据源</label>
			<div class="layui-input-block">
				<label for="sources">
					<input
							type="text"
							id="sources"
							name="sources"
							class="layui-input">
				</label>
			</div>
			<div class="layui-input-block">
				<label for="propagateImmediately" class="layui-form-label" style="width: auto">
					立即传播事件到下个agent
				</label>
				<div class="layui-input-block">
					<input type="checkbox" id="propagateImmediately" name="propagateImmediately" lay-skin="switch"
					       lay-text="是|否">
				</div>
			</div>
		</div>
		<div class="layui-form-item show">
			<label class="layui-form-label">事件接收方</label>
			<div class="layui-input-block">
				<label for="receivers">
					<input
							type="text"
							id="receivers"
							name="receivers"
							class="layui-input">
				</label>
			</div>
		</div>
		<div class="layui-form-item show">
			<label class="layui-form-label">方案</label>
			<div class="layui-input-block">
				<label for="scenarios">
					<div id="scenarios" class="xm-select-scenarios"></div>
				</label>
			</div>
		</div>
		<div class="layui-form-item form-container show">

		</div>
		<div class="layui-form-item">
			<div class="layui-input-block">
				<button class="layui-btn layui-btn-normal layui-btn-sm show" lay-submit lay-filter="saveBtn">保存</button>
				<button class="layui-btn layui-btn-primary layui-btn-sm" lay-filter="back">返回</button>
			</div>
		</div>
	</div>
	<div class="layui-col-sm12 layui-col-md6" id="descriptionHtml">

	</div>
</div>

<script src="/static/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="/static/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
<script>
    layui.use(['form', 'wangEditor', 'jsoneditor', 'request','miniTab','xmSelect'], function () {
        var form = layui.form;
        var $ = layui.$;
        var wangEditor = layui.wangEditor;
        var jsoneditor = layui.jsoneditor;
        var request = layui.request;
        var layer = layui.layer;
        var miniAdmin = layui.miniAdmin;
        var miniTab = layui.miniTab;
        var xmSelect = layui.xmSelect;

        /**
         * 多选下拉框
         */
        var scenarios = xmSelect.render({
            el: '#scenarios',
            toolbar: {
                show: true,
                list: ['CLEAR']
            },
            filterable: true,
            name: 'scenarioIds',
            paging: true,
            pageSize: 10,
            theme: {
                color: '#C1C1C1'
            },
            filterMethod: function (val, item, index, prop) {
                if (val === item.value) {
                    return true;
                }
                return item.name.indexOf(val) !== -1;
            },
            model: {
                label: {
                    block: {
                        template: function (item, sels) {
                            return '<a href="javascript:" onclick="scenarioDetail(' + item.id + ',\'' + item.name + '\')">' + item.name + '</a>';
                        }
                    }
                }
            },
            data: []
        })
        //获取下拉列表
        request.post('/scenarios/all', {}, function (res) {
            if (res.code === 0) {
                scenarios.update({
                    data: res.data,
                    autoRow: true
                })
            } else {
                miniAdmin.error(res.msg)
            }
        }, function () {
            miniAdmin.error('服务器发生错误');
        },true)


        window.scenarioDetail = function (id, name) {
            console.log('id', id, 'name', name);
            sessionStorage.setItem('scenario_id',id)
            miniTab.openNewTabByIframe({
                title:name,
                href:'static/page/scenario/detail.html?id='+id
            })
            setTimeout(function () {
                scenarios.closed();
            }, 10);
        }

		function buildContent(list){
            var html = list.map(function(item){
                return '<li data-type-id="'+item.value+'" onclick="selectAgentType(this)">' +
                    '<div class="agent-type-label">' +
                    '<strong>'+item.name+'</strong>' +
                    '<br>' +
                    '<p>'+item.introduction+'</p>' +
                    '</div>' +
                    '</li>';
            }).join('');
            return '<div class="agent-type-search"> ' +
            '<label> ' +
            '<input type="text" class="layui-input agent-type-name" onkeyup="searchAgentType(this)" placeholder="输入搜索内容"> ' +
            '</label> ' +
            '</div><ul class="agent-type-list">'+html+'</ul>'
		}
        //获取代理类型
        request.get("/agentType", {}, function (res) {
            if (res.code === 0) {
                //执行计划
                $.each(res.data[0].schedules, function (index, item) {
                    $('#schedule').append(new Option(item.desc, item.code));
                });
                //保存时间
                $.each(res.data[0].keepEventsTimes, function (index, item) {
                    $('#keepDataTime').append(new Option(item.desc, item.code));
                });
                layui.form.render("select");
                var types = xmSelect.render({
                    el: '#type',
                    content: buildContent(res.data),
                    name: 'type',
                    theme: {
                        color: '#1F9FFF'
                    },
                    height: 'auto',
                    autoRow: true,
                    model: {
                        label: {
                            type: 'block',
                            block: {
                                //最大显示数量, 0:不限制
                                showCount: 0,
                                //是否显示删除图标
                                showIcon: false
                            }
                        }
                    },
                    data: []
                })
                types.update({
                    data: res.data,
                    autoRow: true
                })
                window.selectAgentType=function (_this) {
                    types.setValue([$(_this).attr('data-type-id')]);
                    setTimeout(function () {
                        types.closed();
                    }, 10);
                }
                window.searchAgentType=function (_this) {
                    var val=$(_this).val();
                    console.log('搜索内容',val)
	                var list=[];
                    if (val){
                        list=[];
                        res.data.map(function(item){
                            if (item.name.indexOf(val) !== -1){
                                list.push(item);
                            }
                        })
                    }else {
                        list=res.data;
                    }
                    types.update({
                        data: list,
                        autoRow: true,
	                    content:buildContent(list)
                    })
                }
            }
        }, function () {
            layer.msg('服务器发生错误', {icon: 5});
        });
    });
</script>
</body>
</html>
